# AIキャラクター初期セットアップ機能 要件定義書

## 1. 概要
新規ユーザーがログイン後、AIキャラクターが存在しない場合に、チャットベースの自然言語インターフェースを使用してAIキャラクターを作成する機能。

## 2. 背景・課題
- 現在、AIキャラクターが存在しないユーザーは404エラーでサービスを利用できない
- AIキャラクター作成は必須だが、フォーム入力では直感的でない
- ユーザーの自然な言葉でキャラクターの性格やスタイルを設定したい

## 3. 目的
- 100%のユーザーがAIキャラクターを持つ状態を実現
- チャット形式で直感的なキャラクター作成体験を提供
- OpenAIを活用した自然言語からの構造化データ変換

## 4. 機能要件

### 4.1 画面遷移
```
ログイン成功 → AIキャラクター存在確認
├── 存在する → 通常のダッシュボード
└── 存在しない → AIキャラクターセットアップページ
```

### 4.2 セットアップフロー
1. **ウェルカムメッセージ**
   - AIキャラクター作成の説明
   - セットアップ開始

2. **ステップ1: 名前設定**
   - AI: "AIアシスタントにどんな名前をつけたいですか？"
   - ユーザー: 自由入力
   - 検証: 1-50文字、必須

3. **ステップ2: 生年月日入力**
   - AI: "より正確なアドバイスのために、あなたの生年月日を教えてください"
   - ユーザー: 年月日選択（カレンダーUI）
   - 検証: 有効な日付、必須

4. **ステップ3: 出生地設定**
   - AI: "出生地を教えてください。日本の方は都道府県を選択してください。海外の方は国名と都市名を入力してください"
   - ユーザー: 
     - 日本の場合: 47都道府県ドロップダウン選択
     - 海外の場合: 自由入力（時差計算なし）
   - 処理: 日本の場合のみSajuEngineで時差調整値を取得
   - 検証: 必須

5. **ステップ4: 出生時間設定（オプション）**
   - AI: "出生時間がわかる場合は教えてください。より詳細で正確な分析が可能になります。わからない場合はスキップしても大丈夫です"
   - ユーザー: 時分選択またはスキップ
   - 検証: オプション

6. **ステップ5: 性格設定**
   - AI: "どんな性格のアドバイザーがお好みですか？"
   - ユーザー: 自然言語で説明
   - 処理: OpenAIでPersonalityScoreに変換

7. **ステップ6: スタイル設定**
   - AI: "どんなアドバイススタイルをお求めですか？"
   - ユーザー: 自然言語で説明
   - 処理: OpenAIでStyleFlagsに変換

8. **確認・作成**
   - 設定内容の表示（生年月日、出生地、AIキャラクター設定）
   - 四柱推命基本データの自動計算・表示
   - AIキャラクター作成
   - 通常のチャットページに遷移

### 4.3 OpenAI変換仕様

#### PersonalityScore変換
```typescript
入力: "優しくて親しみやすい、でもプロフェッショナル"
出力: {
  softness: 80,    // 優しさ (0-100)
  energy: 60,      // エネルギー (0-100)
  formality: 70    // フォーマル度 (0-100)
}
```

#### StyleFlags変換
```typescript
入力: "詳しく丁寧に、でも励ましながら"
出力: ["DETAILED", "ENCOURAGING", "FRIENDLY"]
```

### 4.4 技術要件
- 既存ChatPageのUIコンポーネントを最大限再利用
- OpenAI GPT-4を使用した自然言語処理（性格・スタイルのみ）
- リアルタイムチャットインターフェース
- インラインフォーム要素（構造化データ入力用）
- クライアントサイドバリデーション
- エラーハンドリング（OpenAI API失敗時のフォールバック）

## 5. 非機能要件

### 5.1 パフォーマンス
- OpenAI API応答時間: 5秒以内
- ページ読み込み時間: 2秒以内

### 5.2 ユーザビリティ
- スマートフォン対応必須
- 直感的なチャット操作
- 入力ミス時の再入力対応

### 5.3 信頼性
- OpenAI API失敗時のフォールバック機能
- データ保存失敗時のリトライ機能

## 6. APIエンドポイント仕様

### 6.1 セットアップ状態確認
```
GET /api/ai-characters/setup-status
Response: { needsSetup: boolean, hasCharacter: boolean }
```

### 6.2 自然言語処理
```
POST /api/ai-characters/process-natural-input
Body: { input: string, field: 'personality' | 'style' }
Response: { processedData: PersonalityScore | StyleFlags[] }
```

### 6.3 セットアップ用AIキャラクター作成
```
POST /api/ai-characters/setup
Body: {
  name: string,
  birthDate: string, // ISO 8601形式
  birthPlace: string,
  birthTime?: string, // HH:mm形式、オプション
  personalityInput: string,
  styleInput: string,
  processedPersonality: PersonalityScore,
  processedStyle: StyleFlags[]
}
Response: { 
  success: boolean, 
  character: AICharacter,
  sajuData: FourPillarsData // 四柱推命基本データ
}
```

### 6.4 日本国内出生地リスト取得
```
GET /api/saju/locations/japan
Response: { 
  prefectures: Array<{
    name: string, // 例: "東京都"
    adjustmentMinutes: number // 時差調整値（分）
  }>
}
```

**対応仕様**: 
- **日本**: 全47都道府県（完全対応、時差調整あり）
- **海外**: 自由入力のみ（時差調整なし、標準時間で計算）
- **時差調整**: 日本国内のみSajuEngineで正確な分単位調整

## 7. UI/UXワイヤーフレーム

### 7.1 レイアウト
- 既存ChatPageと同一のレイアウト
- ヘッダー: "AIアシスタント作成"
- チャットエリア: AI ↔ ユーザーの対話
- 入力エリア: ハイブリッド方式（チャット入力 + インラインフォーム）

### 7.2 ハイブリッド入力方式
**チャット入力対応**:
- ステップ1 (名前): 自由テキスト入力
- ステップ5 (性格): 自然言語入力  
- ステップ6 (スタイル): 自然言語入力

**フォーム入力対応**:
- ステップ2 (生年月日): 年月日セレクトボックス
- ステップ3 (出生地): 都道府県ドロップダウン + 海外自由入力
- ステップ4 (出生時間): 時分セレクト + 「わからない」オプション

### 7.3 進捗表示
- 上部に進捗インジケーター (1/6, 2/6, ..., 6/6)
- 現在のステップ説明

### 7.4 フォーム要素仕様
**日付フォーム**:
- 年: 1950-2010年のセレクトボックス
- 月: 1-12月のセレクトボックス  
- 日: 1-31日のセレクトボックス
- デモデータ自動入力: 1990年5月15日

**場所フォーム**:
- ラジオボタン: 「日本国内」「海外」選択
- 日本: 47都道府県のセレクトボックス
- 海外: 自由テキスト入力

**時間フォーム**:
- ラジオボタン: 「時間がわかる」「わからない」選択  
- 時: 0-23時のセレクトボックス
- 分: 0-59分（5分刻み）のセレクトボックス

### 7.5 バリデーション
- フォーム送信時の必須項目チェック
- 無効値の場合はアラート表示
- チャット入力は自然言語のため最小限の検証

## 8. 実装優先度

### Phase 1 (High Priority)
- [ ] AIキャラクター存在確認ロジック
- [ ] セットアップページ基本UI
- [ ] 名前設定機能

### Phase 2 (Medium Priority)
- [ ] OpenAI統合
- [ ] 性格・スタイル自然言語処理
- [ ] データ変換ロジック

### Phase 3 (Low Priority)
- [ ] 確認画面
- [ ] エラーハンドリング強化
- [ ] パフォーマンス最適化

## 9. 成功指標
- セットアップ完了率: 95%以上
- セットアップ所要時間: 平均3分以内
- ユーザー満足度: 4.5/5以上
- OpenAI API成功率: 98%以上

## 10. リスク・制約
- OpenAI API利用料金
- API応答時間の変動
- 自然言語解釈の精度
- 多言語対応（将来的な課題）