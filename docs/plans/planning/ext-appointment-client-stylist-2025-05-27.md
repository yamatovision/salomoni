# 機能拡張計画: 予約登録機能の改善 2025-05-27

## 1. 拡張概要

予約登録モーダルにおいて、既存クライアントの選択機能が欠落しており、また担当スタイリストの一覧が表示されない問題を修正する。これにより、管理者が既存クライアントの予約を効率的に登録でき、適切な担当スタイリストを割り当てることができるようになる。

## 2. 詳細仕様

### 2.1 現状と課題

**既存クライアント選択の問題**：
- 新規クライアントのトグルスイッチはあるが、OFFにしても既存クライアントを選択するUIが表示されない
- 管理者は既存クライアントの予約を登録する際、新規として入力し直す必要がある

**スタイリスト表示の問題**：
- 担当スタイリストセクションは表示されるが、スタイリストの一覧が空になっている
- APIレスポンス形式とフロントエンドの期待する形式が一致していない

### 2.2 拡張内容

1. **既存クライアント選択機能**
   - 新規クライアントトグルがOFFの場合、既存クライアントを選択できるドロップダウンを表示
   - クライアント名で検索可能なオートコンプリート機能
   - 選択したクライアントの情報（電話番号、性別等）をプレビュー表示

2. **スタイリスト表示の修正**
   - APIレスポンス形式に合わせてフロントエンドのデータ処理を修正
   - スタイリスト一覧を正しく表示し、ラジオボタンで選択可能にする

## 3. ディレクトリ構造

修正が必要な既存ファイル：
```
frontend/
├── src/
│   ├── pages/
│   │   └── admin/
│   │       └── AppointmentManagementPage.tsx  # 既存クライアント選択UI追加、データ処理修正
│   └── services/
│       └── api/
│           └── users.ts  # getUsersメソッドのレスポンス処理修正
```

## 4. 技術的影響分析

### 4.1 影響範囲

- **フロントエンド**: 
  - AppointmentManagementPage（新規予約登録モーダル）
  - UserServiceのgetUsersメソッド
- **バックエンド**: 変更なし（APIは正常に動作している）
- **データモデル**: 変更なし
- **その他**: なし

### 4.2 変更が必要なファイル

```
- frontend/src/services/api/users.ts: getUsersメソッドのレスポンス処理を修正
- frontend/src/pages/admin/AppointmentManagementPage.tsx: 既存クライアント選択UI追加、スタイリスト取得処理修正
```

## 5. タスクリスト

```
- [ ] **T1**: users.tsのgetUsersメソッドを修正（ページネーション付きレスポンスに対応）
- [ ] **T2**: AppointmentManagementPageのfetchStylists関数を修正（正しいレスポンス形式に対応）
- [ ] **T3**: 既存クライアント選択用のAutocompleteコンポーネントを実装
- [ ] **T4**: 新規/既存クライアント切り替え時のUI制御ロジックを実装
- [ ] **T5**: 選択したクライアント情報のプレビュー表示を実装
- [ ] **T6**: 予約登録APIコールに既存クライアントID送信処理を追加
```

## 6. テスト計画

1. **スタイリスト表示のテスト**
   - 予約登録モーダルを開いた際、スタイリスト一覧が正しく表示されることを確認
   - ラジオボタンでスタイリストを選択できることを確認

2. **既存クライアント選択のテスト**
   - 新規クライアントトグルをOFFにした際、既存クライアント選択UIが表示されることを確認
   - クライアント名で検索し、適切な候補が表示されることを確認
   - 選択したクライアントの情報がプレビュー表示されることを確認

3. **予約登録の統合テスト**
   - 既存クライアントを選択して予約を登録できることを確認
   - 登録後、予約一覧に正しく反映されることを確認

## 7. SCOPE_PROGRESSへの統合

SCOPE_PROGRESS.mdの「Phase 6: 予約管理」セクションに以下のタスクを追加：

```markdown
- [ ] **A-004-EXT1**: 予約登録機能の改善
  - 目標: 2025-05-28
  - 参照: [/docs/plans/planning/ext-appointment-client-stylist-2025-05-27.md]
  - 内容: 既存クライアント選択機能の追加とスタイリスト表示問題の修正
```

## 8. 備考

- 既存のAPIは正常に動作しているため、バックエンドの変更は不要
- フロントエンドのみの修正で対応可能
- 将来的には、クライアントの予約履歴に基づいたスタイリスト推奨機能の実装も検討