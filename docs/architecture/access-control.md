# アクセス制御マトリックス

## 1. ユーザーロール定義

| ロールID | ロール名 | 説明 | 主な責務 |
|---------|---------|------|---------|
| SUPER_ADMIN | SuperAdmin | サービス運営スタッフ | 全組織の管理、サブスク管理、システム全体の監視 |
| OWNER | オーナー | サロンオーナー・経営者 | 組織管理、課金管理、スタッフ管理の最終権限 |
| ADMIN | 管理者 | 店長・マネージャー | 日常的な店舗運営、スタッフ・顧客管理 |
| USER | スタイリスト | 現役美容師 | AIチャット利用、顧客対応、自己の業務管理 |
| CLIENT | クライアント | 美容室の来店客 | 専用AIチャットの利用のみ |

## 2. リソースとアクション定義

### 2.1 アクション一覧

- **C**: Create（作成）
- **R**: Read（読取）
- **U**: Update（更新）
- **D**: Delete（削除）
- **E**: Execute（実行）- 特殊操作用

### 2.2 リソース一覧

1. **組織管理リソース**
2. **ユーザー管理リソース**
3. **クライアント管理リソース**
4. **AIチャット関連リソース**
5. **四柱推命・運勢リソース**
6. **予約管理リソース**
7. **課金・決済リソース**
8. **サポート管理リソース**

## 3. アクセス制御マトリックス

### 3.1 組織管理

| リソース | アクション | SUPER_ADMIN | OWNER | ADMIN | USER | CLIENT |
|---------|-----------|-------------|--------|--------|------|---------|
| 組織情報 | C | ✓ | ✗ | ✗ | ✗ | ✗ |
| 組織情報 | R | ✓ | ✓* | ✓* | ✓* | ✗ |
| 組織情報 | U | ✓ | ✓* | ✗ | ✗ | ✗ |
| 組織情報 | D | ✓ | ✗ | ✗ | ✗ | ✗ |
| 組織ステータス | U | ✓ | ✗ | ✗ | ✗ | ✗ |
| 組織統計 | R | ✓ | ✓* | ✓* | ✗ | ✗ |

### 3.2 ユーザー管理

| リソース | アクション | SUPER_ADMIN | OWNER | ADMIN | USER | CLIENT |
|---------|-----------|-------------|--------|--------|------|---------|
| ユーザー（スタッフ） | C | ✓ | ✓* | ✓*† | ✗ | ✗ |
| ユーザー（スタッフ） | R | ✓ | ✓* | ✓* | ✓‡ | ✗ |
| ユーザー（スタッフ） | U | ✓ | ✓* | ✓*† | ✓** | ✗ |
| ユーザー（スタッフ） | D（無効化） | ✓ | ✓* | ✗ | ✗ | ✗ |
| ユーザーロール変更 | E | ✓ | ✓* | ✗ | ✗ | ✗ |
| 強制ログアウト | E | ✓ | ✓* | ✓* | ✗ | ✗ |
| トークン使用量（個人） | R | ✓ | ✓* | ✓* | ✓** | ✗ |

### 3.3 クライアント管理

| リソース | アクション | SUPER_ADMIN | OWNER | ADMIN | USER | CLIENT |
|---------|-----------|-------------|--------|--------|------|---------|
| クライアント情報 | C | ✗ | ✓* | ✓* | ✓* | ✗ |
| クライアント情報 | R | ✗ | ✓* | ✓* | ✓* | ✗ |
| クライアント情報 | U | ✗ | ✓* | ✓* | ✓* | ✗ |
| クライアント情報 | D | ✗ | ✓* | ✓* | ✗ | ✗ |
| クライアント四柱推命 | R | ✗ | ✓* | ✓* | ✓* | ✗ |
| クライアント相性診断 | R | ✗ | ✓* | ✓* | ✓* | ✗ |

### 3.4 AIチャット関連

| リソース | アクション | SUPER_ADMIN | OWNER | ADMIN | USER | CLIENT |
|---------|-----------|-------------|--------|--------|------|---------|
| 個人AIチャット | C/R/U | ✗ | ✓** | ✓** | ✓** | ✗ |
| クライアント向けAI設定 | C/U | ✗ | ✓* | ✓* | ✓* | ✗ |
| クライアント専用チャット | R | ✗ | ✗ | ✗ | ✗ | ✓** |
| チャット履歴（個人） | R | ✗ | ✗ | ✗ | ✓** | ✗ |
| チャット履歴（クライアント） | R | ✗ | ✓* | ✓* | ✓* | ✓** |
| AIメモリ管理 | R/U/D | ✗ | ✗ | ✗ | ✓** | ✓** |
| スタイリストレポート生成 | E | ✗ | ✓* | ✓* | ✗ | ✗ |

### 3.5 四柱推命・運勢

| リソース | アクション | SUPER_ADMIN | OWNER | ADMIN | USER | CLIENT |
|---------|-----------|-------------|--------|--------|------|---------|
| 自分の運勢 | R | ✗ | ✓ | ✓ | ✓ | ✓ |
| 他者の運勢 | R | ✗ | ✓* | ✓* | ✓*§ | ✗ |
| 相性診断実行 | E | ✗ | ✓* | ✓* | ✓* | ✗ |
| 運勢カード生成 | E | ✗ | ✓ | ✓ | ✓ | ✓ |

### 3.6 予約管理

| リソース | アクション | SUPER_ADMIN | OWNER | ADMIN | USER | CLIENT |
|---------|-----------|-------------|--------|--------|------|---------|
| 予約 | C | ✗ | ✓* | ✓* | ✓* | ✗ |
| 予約 | R | ✗ | ✓* | ✓* | ✓*¶ | ✗ |
| 予約 | U | ✗ | ✓* | ✓* | ✓*¶ | ✗ |
| 予約 | D | ✗ | ✓* | ✓* | ✗ | ✗ |
| 担当者割当 | E | ✗ | ✓* | ✓* | ✗ | ✗ |
| カレンダー同期設定 | C/R/U | ✗ | ✓* | ✓* | ✗ | ✗ |

### 3.7 課金・決済

| リソース | アクション | SUPER_ADMIN | OWNER | ADMIN | USER | CLIENT |
|---------|-----------|-------------|--------|--------|------|---------|
| プラン情報 | R | ✓ | ✓* | ✓* | ✗ | ✗ |
| プラン変更 | E | ✓ | ✓* | ✗ | ✗ | ✗ |
| 支払い方法 | C/R/U/D | ✗ | ✓* | ✗ | ✗ | ✗ |
| 請求書 | R | ✓ | ✓* | ✗ | ✗ | ✗ |
| トークン購入 | E | ✗ | ✓* | ✗ | ✗ | ✗ |
| トークン使用状況（組織） | R | ✓ | ✓* | ✓* | ✗ | ✗ |

### 3.8 サポート管理

| リソース | アクション | SUPER_ADMIN | OWNER | ADMIN | USER | CLIENT |
|---------|-----------|-------------|--------|--------|------|---------|
| サポートチケット | C | ✗ | ✓ | ✓ | ✓ | ✗ |
| サポートチケット | R | ✓ | ✓** | ✓** | ✓** | ✗ |
| サポートチケット | U（返信） | ✓ | ✓** | ✓** | ✓** | ✗ |
| サポートチケット | D（クローズ） | ✓ | ✓** | ✗ | ✗ | ✗ |
| 全組織のチケット | R | ✓ | ✗ | ✗ | ✗ | ✗ |

## 4. 凡例・特殊条件

### 4.1 記号の意味

- **✓**: 許可（制限なし）
- **✗**: 禁止
- **\***: 自組織内のリソースのみ
- **\*\***: 自分自身のリソースのみ
- **†**: USER（スタイリスト）ロールのユーザーのみ作成・更新可能
- **‡**: 同一組織内の他スタイリストの基本情報のみ閲覧可能
- **§**: クライアントの運勢情報のみ閲覧可能
- **¶**: 自分が担当する予約のみ

### 4.2 特殊条件の詳細

1. **組織境界の原則**
   - SuperAdmin以外は、所属する組織のデータのみアクセス可能
   - 組織間のデータ共有は原則として禁止

2. **階層的権限の例外**
   - Ownerは組織内の全権限を持つが、個人のAIチャット履歴は閲覧不可（プライバシー保護）
   - AdminはUserの作成・管理が可能だが、ロール変更は不可（Ownerのみ）

3. **クライアントデータの扱い**
   - クライアントデータは組織に紐づき、スタイリストが退職しても組織に残る
   - クライアント専用AIチャットは、該当クライアントのみアクセス可能

4. **トークン使用量の可視化**
   - 各スタイリストは自分のトークン使用量を確認可能
   - 管理者は組織全体およびスタイリスト別の使用量を確認可能

5. **レポート生成の制限**
   - スタイリストの会話履歴レポートは、Owner/Adminのみ生成可能
   - レポート内容はプライバシーに配慮し、段階的開示方式を採用

## 5. API エンドポイントとロール制限

### 5.1 認証不要（Public）エンドポイント

```
POST /api/auth/login
POST /api/auth/register
POST /api/auth/password-reset-request
GET  /api/auth/verify-reset-token
POST /api/auth/complete-password-reset
```

### 5.2 ロール別アクセス可能エンドポイント

#### SuperAdmin専用
```
GET  /api/superadmin/organizations
POST /api/superadmin/organizations
PUT  /api/superadmin/organizations/:id
GET  /api/superadmin/support/tickets
```

#### Owner以上
```
POST /api/users/invite
PUT  /api/organizations/:id
POST /api/billing/charge-tokens
PUT  /api/billing/plan
```

#### Admin以上
```
GET  /api/admin/dashboard
POST /api/clients
PUT  /api/appointments/:id/assign
GET  /api/admin/stylists/:id/report
```

#### User以上
```
GET  /api/chat/conversations
POST /api/chat/conversations/:id/send
GET  /api/fortune/daily
GET  /api/clients/daily
```

#### Client専用
```
GET  /api/clients/:id/chat
POST /api/clients/:id/chat/send
GET  /api/clients/:id/fortune
```

## 6. 実装上の注意事項

### 6.1 ミドルウェアでの権限チェック

```typescript
// 例: Admin以上のみアクセス可能
router.use('/api/admin', authenticate, authorize(['admin', 'owner', 'superadmin']));

// 例: 自組織のリソースのみアクセス可能
router.get('/api/clients/:id', authenticate, checkOrganizationAccess);

// 例: 自分自身のリソースのみアクセス可能
router.get('/api/users/:id/token-usage', authenticate, checkSelfAccess);
```

### 6.2 データレベルのアクセス制御

1. **クエリレベルでのフィルタリング**
   - 組織IDでのフィルタリングを必須化
   - ユーザーIDでのフィルタリングを適切に実装

2. **レスポンスデータの制限**
   - ロールに応じて返却フィールドを制限
   - 機密情報（パスワードハッシュ等）は決して返却しない

3. **監査ログの考慮**
   - 重要な操作（ユーザー作成、権限変更等）は記録を検討
   - ただし、通常のAPI利用ログは不要（要件に基づく）

## 7. 今後の拡張考慮事項

1. **細分化された権限管理**
   - 将来的に、より詳細な権限設定が必要になる可能性
   - 例：「クライアント情報の閲覧のみ可能」な限定ロール

2. **一時的な権限付与**
   - 休暇中の引き継ぎなど、一時的な権限昇格の仕組み

3. **API利用制限の組織別設定**
   - プランに応じたAPI利用上限の実装