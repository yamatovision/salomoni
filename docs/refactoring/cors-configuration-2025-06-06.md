# リファクタリング計画: CORS設定の統一と最適化 2025-06-06

## 1. 現状分析

### 1.1 対象概要
SalomoniプロジェクトのCORS（Cross-Origin Resource Sharing）設定は、フロントエンド（localhost:5173）とバックエンド（localhost:3001）間の通信を可能にするために実装されています。現在、認証情報を含むリクエストでCORSエラーが発生しており、開発効率が著しく低下しています。

### 1.2 問題点と課題
- **重複したCORS実装**: `cors.ts`と`cors-handler.ts`の2つのミドルウェアが存在
- **不完全なOPTIONSリクエスト処理**: プリフライトリクエストで`Access-Control-Allow-Credentials`ヘッダーが欠落
- **ミドルウェアの競合**: 不明なミドルウェアがCORSヘッダーを上書きしている可能性
- **corsパッケージの削除後も問題が継続**: カスタム実装でも問題が解決していない
- **設定の分散**: CORS設定が複数の場所に分散している
- **デバッグの困難さ**: 問題の原因を特定するための適切なログが不足

### 1.3 関連ファイル一覧
- `backend/src/index.ts` - メインアプリケーション、CORS設定の適用
- `backend/src/common/middleware/cors.ts` - 基本的なCORSミドルウェア
- `backend/src/common/middleware/cors-handler.ts` - 完全なCORSハンドラー（未使用）
- `frontend/src/services/api/apiClient.ts` - Axiosクライアント設定
- `backend/.env` - 環境変数（ALLOWED_ORIGINS）
- `frontend/.env` - 環境変数（VITE_API_BASE_URL）

### 1.4 依存関係図
```
フロントエンド (localhost:5173)
    ↓ 
    └── apiClient.ts (withCredentials: true)
         ↓
         └── HTTP Request with credentials
              ↓
              └── バックエンド (localhost:3001)
                   ├── helmetミドルウェア
                   ├── corsミドルウェア（現在はcorsパッケージ使用）
                   ├── express.json()
                   ├── cookieParser()
                   └── 各種ルート
```

## 2. リファクタリングの目標

### 2.1 期待される成果
- **CORS設定の一元化**: 単一の場所でCORS設定を管理
- **完全なOPTIONS対応**: プリフライトリクエストが確実に処理される
- **コード削減**: 重複実装の除去により約50行削減（25%削減）
- **デバッグ性向上**: 詳細なログ出力により問題の迅速な特定が可能
- **保守性向上**: シンプルで理解しやすい実装

### 2.2 維持すべき機能
- 環境変数による動的なオリジン設定
- 認証情報（Cookie）を含むリクエストのサポート
- 開発環境と本番環境での適切な動作
- セキュリティを維持したCORS設定

## 3. 理想的な実装

### 3.1 全体アーキテクチャ
```
backend/
├── src/
│   ├── index.ts              # シンプルなCORS設定のみ
│   └── common/
│       └── middleware/
│           └── cors.ts       # 統一されたCORSミドルウェア（削除）
```

### 3.2 核心的な改善ポイント
1. **ミドルウェアの順序を最優先**: CORSミドルウェアを他のすべてのミドルウェアより前に配置
2. **OPTIONSリクエストの早期リターン**: プリフライトリクエストを最速で処理
3. **明示的なヘッダー設定**: すべての必要なヘッダーを明示的に設定
4. **エラーハンドリング**: 不正なオリジンに対する適切なエラーレスポンス

### 3.3 新しいディレクトリ構造
```
backend/src/
├── index.ts                    # CORS設定を直接実装
└── common/
    └── middleware/
        ├── cors.ts            # 削除
        └── cors-handler.ts    # 削除
```

## 4. 実装計画

### フェーズ1: 既存実装の整理とデバッグ
- **目標**: 問題の根本原因を完全に特定し、不要なコードを削除
- **影響範囲**: backend/src/index.ts, cors関連ミドルウェア
- **タスク**:
  1. **T1.1**: デバッグログの追加
     - 対象: backend/src/index.ts
     - 実装: ミドルウェアスタックの可視化、OPTIONSリクエストの詳細ログ
  2. **T1.2**: 重複実装の削除
     - 対象: backend/src/common/middleware/cors.ts, cors-handler.ts
     - 実装: ファイルの削除
  3. **T1.3**: corsパッケージの再インストール（一時的）
     - 対象: backend/package.json
     - 実装: npm install cors @types/cors（動作確認用）
- **検証ポイント**:
  - OPTIONSリクエストで正しいヘッダーが返されるか
  - 通常のリクエストでCORS設定が適用されるか
  - ログで問題の原因が特定できるか

### フェーズ2: シンプルなCORS実装への移行
- **目標**: index.ts内で完結するシンプルなCORS実装
- **影響範囲**: backend/src/index.ts
- **タスク**:
  1. **T2.1**: カスタムCORSハンドラーの実装
     - 対象: backend/src/index.ts:40-49
     - 実装: インラインでCORSロジックを実装
  2. **T2.2**: OPTIONSメソッドの専用ハンドラー
     - 対象: backend/src/index.ts（ルート定義前）
     - 実装: app.options('*', corsHandler)を追加
  3. **T2.3**: ミドルウェア順序の最適化
     - 対象: backend/src/index.ts
     - 実装: CORSを最初のミドルウェアとして配置
- **検証ポイント**:
  - ログイン機能が正常に動作するか
  - APIリクエストがCORSエラーなく処理されるか
  - パフォーマンスへの影響がないか

### フェーズ3: 環境別設定の最適化
- **目標**: 開発・本番環境での適切なCORS設定
- **影響範囲**: backend/.env, frontend/vite.config.ts
- **タスク**:
  1. **T3.1**: 開発環境向けプロキシ設定の追加
     - 対象: frontend/vite.config.ts
     - 実装: Viteのプロキシ設定でCORS回避
  2. **T3.2**: 本番環境向けCORS設定の文書化
     - 対象: docs/deployment/cors-setup.md（新規）
     - 実装: 本番環境での設定ガイド作成
  3. **T3.3**: 環境変数の整理
     - 対象: backend/.env, frontend/.env
     - 実装: 不要な変数の削除、命名の統一
- **検証ポイント**:
  - 開発環境でプロキシ経由の通信が動作するか
  - 環境変数の変更が正しく反映されるか

## 5. 期待される効果

### 5.1 コード削減
- cors.ts: 30行削除
- cors-handler.ts: 86行削除
- index.tsの簡略化: 約20行削減
- **合計**: 約136行削減（CORS関連コードの70%削減）

### 5.2 保守性向上
- CORS設定が1箇所に集約
- 設定の変更が容易
- デバッグが簡単
- 新規開発者の理解が容易

### 5.3 拡張性改善
- 新しいオリジンの追加が環境変数のみで可能
- 条件付きCORS設定の追加が容易
- API別のCORS設定にも対応可能

## 6. リスクと対策

### 6.1 潜在的リスク
1. **既存機能への影響**: CORS設定変更により一部のAPIが動作しなくなる可能性
2. **セキュリティリスク**: 設定ミスによる過度に寛容なCORS設定
3. **ブラウザ互換性**: 古いブラウザでの動作問題

### 6.2 対策
1. **段階的移行**: 各フェーズ後に完全なテストを実施
2. **セキュリティレビュー**: ALLOWED_ORIGINSの厳密な管理
3. **フォールバック**: 問題発生時は即座にcorsパッケージに戻せる準備

## 7. 備考

### 即時対応案
開発を継続するため、以下の回避策も検討：
1. フロントエンドでViteプロキシを使用（/api/* → http://localhost:3001/api/*）
2. 開発環境のみCORS無効化オプションの追加
3. nginxリバースプロキシの使用

### 長期的改善案
1. GraphQLの導入によるエンドポイントの統一
2. BFF（Backend for Frontend）パターンの採用
3. サービスメッシュによるCORS処理の外部化

---

実装開始予定日: 2025年6月6日
実装完了予定日: 2025年6月7日
担当者: リファクタリングマネージャー